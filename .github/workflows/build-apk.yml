name: üöÄ Build VCamera APK

on:
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Build type'
        required: true
        type: choice
        options:
          - debug
          - release
          - both
        default: 'debug'
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  build:
    name: üì± Build Android APK
    runs-on: ubuntu-latest
    
    steps:
    - name: üì• Checkout Code
      uses: actions/checkout@v4
      
    - name: ‚òï Setup JDK 17
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
        cache: 'gradle'
        
    - name: üîë Make Gradlew Executable
      run: chmod +x gradlew
      
    - name: üìä Environment Info
      run: |
        echo "=================================================="
        echo "üîß BUILD ENVIRONMENT"
        echo "=================================================="
        echo ""
        echo "üîπ Gradle Version:"
        ./gradlew --version | grep "Gradle"
        echo ""
        echo "üîπ Java Version:"
        java -version 2>&1 | head -3
        echo ""
        echo "üîπ Project Configuration:"
        cat gradle/wrapper/gradle-wrapper.properties | grep "distributionUrl"
        echo ""
        echo "üîπ Build Type: ${{ github.event.inputs.build_type || 'debug' }}"
        echo ""
        echo "=================================================="
        
    - name: üßπ Clean Build
      run: ./gradlew clean --stacktrace
      
    - name: üî® Build Debug APK
      if: github.event.inputs.build_type != 'release'
      run: |
        echo "Building Debug APK..."
        ./gradlew assembleDebug --stacktrace --info
        
    - name: üî® Build Release APK
      if: github.event.inputs.build_type == 'release' || github.event.inputs.build_type == 'both'
      run: |
        echo "Building Release APK..."
        ./gradlew assembleRelease --stacktrace --info
      continue-on-error: true
      
    - name: üì¶ List Build Outputs
      run: |
        echo "=================================================="
        echo "üì¶ BUILD OUTPUTS"
        echo "=================================================="
        echo ""
        if [ -d "app/build/outputs/apk" ]; then
          find app/build/outputs/apk -name "*.apk" -exec ls -lh {} \;
        else
          echo "No APK files found"
        fi
        echo ""
        echo "=================================================="
        
    - name: ‚úÖ Build Success Summary
      if: success()
      run: |
        echo ""
        echo "=================================================="
        echo "üéä BUILD SUCCESSFUL!"
        echo "=================================================="
        echo ""
        
        if [ -f "app/build/outputs/apk/debug/app-debug.apk" ]; then
          SIZE=$(ls -lh app/build/outputs/apk/debug/app-debug.apk | awk '{print $5}')
          echo "‚úÖ Debug APK: $SIZE"
        fi
        
        if [ -f "app/build/outputs/apk/release/app-release-unsigned.apk" ]; then
          SIZE=$(ls -lh app/build/outputs/apk/release/app-release-unsigned.apk | awk '{print $5}')
          echo "‚úÖ Release APK: $SIZE"
        fi
        
        echo ""
        echo "üì• Download APKs from Artifacts section below"
        echo "=================================================="
        
    - name: üì§ Upload Debug APK
      if: success() && github.event.inputs.build_type != 'release'
      uses: actions/upload-artifact@v4
      with:
        name: vcamera-debug-apk-${{ github.run_number }}
        path: app/build/outputs/apk/debug/app-debug.apk
        retention-days: 30
        
    - name: üì§ Upload Release APK
      if: success() && (github.event.inputs.build_type == 'release' || github.event.inputs.build_type == 'both')
      uses: actions/upload-artifact@v4
      with:
        name: vcamera-release-apk-${{ github.run_number }}
        path: app/build/outputs/apk/release/*.apk
        retention-days: 30
      continue-on-error: true
      
    - name: üîç Build Logs on Failure
      if: failure()
      run: |
        echo "=================================================="
        echo "‚ùå BUILD FAILED - SHOWING LOGS"
        echo "=================================================="
        echo ""
        if [ -f "app/build/outputs/logs/gradle.log" ]; then
          cat app/build/outputs/logs/gradle.log | tail -100
        fi
        echo ""
        echo "Check full logs above for details"
        echo "=================================================="
        
    - name: üéâ Installation Instructions
      if: success()
      run: |
        echo ""
        echo "=================================================="
        echo "üì± INSTALLATION GUIDE"
        echo "=================================================="
        echo ""
        echo "1. Download APK:"
        echo "   ‚Ä¢ Scroll down to 'Artifacts' section"
        echo "   ‚Ä¢ Click to download ZIP file"
        echo "   ‚Ä¢ Extract app-debug.apk"
        echo ""
        echo "2. Install via ADB:"
        echo "   adb install app-debug.apk"
        echo ""
        echo "3. Install on Phone:"
        echo "   ‚Ä¢ Transfer APK to phone"
        echo "   ‚Ä¢ Enable 'Unknown Sources'"
        echo "   ‚Ä¢ Tap APK to install"
        echo ""
        echo "=================================================="
